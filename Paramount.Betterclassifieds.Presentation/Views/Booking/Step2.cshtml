@using Paramount
@using Paramount.Betterclassifieds.Presentation.Framework
@model Paramount.Betterclassifieds.Presentation.ViewModels.Booking.Step2View

@{
    ViewBag.Title = "Design Ad";
    Layout = @Url.ClientUrl("~/Views/Shared/_ApplicationLayout.cshtml");
}
<ul class="nav nav-tabs" role="tablist">
    <li>@Html.ActionLink("1", "Step1")</li>
    <li class="active"><a href="#">Step 2</a></li>
    <li class="disabled"><a href="#">3</a></li>
    <li class="disabled"><a href="#">4</a></li>
</ul>


@Html.Partial("_PriceSummary")

<form role="form" id="adDesignForm" action="@Url.Action("Step2", "Booking")" method="POST">
    @Html.AntiForgeryToken()
    @Html.HiddenFor(m => m.IsLineAdIncluded)

    <div class="row top-buffer-20">
        <div class="col-xs-12">
            <div class="bs-callout bs-callout-info">
                <h4>Online Ad Details</h4>
                <p>Ok. You might want to entice the readers with an impact heading.</p>
            </div>

            <div class="form-group">
                @Html.LabelFor(m => m.OnlineAdHeading)
                @Html.BootstrapLargeTextBoxFor(m => m.OnlineAdHeading)
                @Html.ValidationMessageFor(m => m.OnlineAdHeading)
            </div>

            <div class="form-group">
                @Html.LabelFor(m => m.OnlineAdDescription)
                @Html.BootstrapLargeTextAreaFor(m => m.OnlineAdDescription, 8)
                @Html.ValidationMessageFor(m => m.OnlineAdDescription)
            </div>

            <div class="form-group">
                @Html.LabelFor(m => m.OnlineAdContactName)
                @Html.BootstrapLargeTextBoxFor(m => m.OnlineAdContactName)
                @Html.ValidationMessageFor(m => m.OnlineAdContactName)
            </div>

            <div class="form-group">
                @Html.LabelFor(m => m.OnlineAdEmail)
                @Html.BootstrapLargeTextBoxFor(m => m.OnlineAdEmail)
                @Html.ValidationMessageFor(m => m.OnlineAdEmail)
            </div>

            <div class="form-group">
                @Html.LabelFor(m => m.OnlineAdPhone)
                @Html.BootstrapLargeTextBoxFor(m => m.OnlineAdPhone)
                @Html.ValidationMessageFor(m => m.OnlineAdPhone)
            </div>

            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group">
                        @Html.LabelFor(m => m.OnlineAdLocationId)
                        <select id="OnlineAdLocationId" name="OnlineAdLocationId"
                                class="form-control input-lg js-select"
                                data-selected="@Model.OnlineAdLocationId"
                                data-url="@Url.LocationOptions()"></select>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="form-group">
                        @Html.LabelFor(m => m.OnlineAdLocationAreaId)
                        <select id="OnlineAdLocationAreaId" name="OnlineAdLocationAreaId"
                                class="form-control input-lg js-select"
                                data-selected="@Model.OnlineAdLocationAreaId"
                                data-url="@Url.LocationAreaOptions(Model.OnlineAdLocationId)"></select>
                    </div>
                </div>
            </div>

            <div class="panel panel-default" id="onlineImages">
                
                <div class="panel-heading">
                    Online Images &nbsp;
                    <span class="btn btn-success fileinput-button" data-bind="css : { hidden : !maxLimitNotReached() }">
                        <i class="fa fa-upload"></i>
                        <span>Upload Image</span>
                        <!-- The file input field used as target for the file upload widget -->
                        <input id="fileupload" type="file" name="files[]" multiple>
                    </span>
                </div>
                <div class="panel-body upload-thumbs">
                    <div class="alert alert-warning">
                        Max image size @Model.MaxImageUploadInMegabytes.ToString("F1") MB.

                        @if (Model.MaxOnlineImages.HasValue)
                        {
                            <span>You can upload up to @Model.MaxOnlineImages images.</span>
                        }
                    </div>

                    <div class="alert alert-danger" data-bind="text : errorMsg, css : { hidden : errorMsg().length == 0 }"></div>
                    <div class="progress progress-striped active" data-bind="visible: uploadImageInProgress">
                        <div class="progress-bar active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                            <span data-bind="visible: uploadImageInProgress">Uploading...</span>
                        </div>
                    </div>

                    <div class="row" data-bind="foreach: adImages">
                        <div class="col-lg-2 col-md-3 col-sm-4 col-xs-6">
                            <div class="thumbnail">
                                <img data-bind="attr: {src: $paramount.svc.getImageUrl($data) }" />
                                <div class="caption">
                                    <button class="btn btn-warning btn-block" title="Remove" data-bind="click: $parent.removeImage">
                                        <span class="glyphicon glyphicon-trash"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr />
    @*line ad details*@
    @if (Model.IsLineAdIncluded)
    {
        <div class="row top-buffer-10">
            <div class="col-xs-12">
                <div class="bs-callout bs-callout-info">
                    <h4>Print Ad Details</h4>
                    <p>These details will be displayed on the selected publications.</p>
                </div>
                <a id="copyOnlineAdDetails"
                   class="btn btn-primary pull-right cancel"
                   data-loading-text="Converting...">
                    Copy From Online Ad <i class="glyphicon glyphicon-arrow-down"></i>
                </a>
            </div>
        </div>

        <div class="row top-buffer-10">
            <div class="col-xs-12">

                <div class="form-group">
                    @Html.LabelFor(m => m.LineAdHeader)
                    @Html.BootstrapLargeTextBoxFor(m => m.LineAdHeader, attributes: new Dictionary<string, object>
                    {
                        {"data-bind", "value: lineAdHeader"}
                    })
                    @Html.ValidationMessageFor(m => m.LineAdHeader)

                </div>
                <div class="form-group">
                    <div class="form-control">
                        <label>
                            @Html.CheckBoxFor(m => m.LineIsSuperBoldHeading) @Html.LabelFor(m => m.LineIsSuperBoldHeading)
                        </label>
                    </div>

                </div>
                <div class="form-group">
                    @Html.LabelFor(m => m.LineAdText)
                    @Html.BootstrapLargeTextAreaFor(m => m.LineAdText, 5, attributes: new Dictionary<string, object>()
                    {
                        {"data-bind", "value: lineAdText, html: lineAdText, valueUpdate: ['afterkeydown', 'input']"}
                    })
                    <span class="help-block">Word Count: <span data-bind="text: wordCount"></span></span>
                    @Html.ValidationMessageFor(m => m.LineAdText)
                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">
                        Print Image &nbsp;
                        <span class="btn btn-default btn-success fileinput-button" data-bind="visible: lineAdImageId() === ''">
                            <i class="fa fa-upload"></i>
                            <span>Upload for Print</span>
                            <!-- The file input field used as target for the file upload widget -->
                            <input id="fileuploadPrint" type="file" name="files[]" multiple>
                        </span>
                    </div>
                    <div class="panel-body">

                        <div class="row" id="printImageSelector">
                            <div class="col-xs-12">
                                <div class="alert alert-warning">
                                    Max image size @Model.MaxImageUploadInMegabytes.ToString("F1") MB.
                                    Print image requires specific dimension (aspect ratio). Please upload a new 
                                    image to prepare it for print.
                                </div>
                            </div>
                        </div>

                        <div class="row" id="printImagePreview" data-bind="visible: lineAdImageId() !== ''">
                            <div class="col-lg-2 col-md-3 col-sm-4 col-xs-6">
                                <div class="thumbnail">
                                    <img id="printImg" data-bind="attr : { src : $paramount.svc.getImageUrl(lineAdImageId()) }" />
                                    <div class="caption">
                                        <button class="btn btn-warning btn-block" title="Remove" data-bind="click: removePrintImage">
                                            <span class="glyphicon glyphicon-trash"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row top-buffer-10">
                            <div class="col-xs-12">
                                <div id="fileUploadPrintProgress" class="progress progress-striped active no-display">
                                    <div class="progress-bar active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                                        <span>Uploading...</span>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    }

    @*Pager*@
    <ul class="pager">
        <li class="previous">
            <button id="btnPrev" class="btn btn-large btn-default js-load" data-nav='@Url.Action("Step1")'>
                <i class="glyphicon glyphicon-arrow-left"></i> Previous
            </button>
        </li>
        <li class="next">
            <button id="btnSubmit" type="submit" class="btn btn-large btn-default">Next <i class="glyphicon glyphicon-arrow-right"></i></button>
        </li>
    </ul>

</form>

@Html.Partial("_CropImage")

@section Scripts{

    <script src="@Url.Content("~/Scripts/jquery.cleditor.min.js")"></script>
    <script src="@Url.Content("~/Scripts/cropper.js")"></script>
    <script>

        (function($, $paramount) {
            var editor;

            $paramount.setOnlineEditor(function() {
                editor = $('#OnlineAdDescription').cleditor({
                    controls: "bold italic underline strikethrough subscript superscript | font size " +
                        "style | color highlight removeformat | bullets numbering | outdent " +
                        "indent | alignleft center alignright justify | undo redo | " +
                        "rule image link unlink | cut copy paste pastetext",
                    fonts: " Arial,Arial Black,Comic Sans MS,Courier New,Narrow,Garamond," +
                        "Georgia,Impact,Sans Serif,Serif,Tahoma,Trebuchet MS,Verdana",
                    sizes: "1,2,3,4,5,6,7",
                    styles: [["Paragraph", "<p>"], ["Header 3", "<h3>"], ["Header 4", "<h4>"], ["Header 5", "<h5>"], ["Header 6", "<h6>"]],
                    bodyStyle: "margin:4px; font:14pt Arial; cursor:text"
                });
            });

            $(function() {
                // on ready

                $('#OnlineAdLocationId').on('change', function() {
                    $('#OnlineAdLocationAreaId').loadLocationAreas('@Url.Action("GetLocationAreas", "Location")', $(this).val(), false);
                });

                $('#copyOnlineAdDetails').click(function() {
                    // copy header
                    $('#LineAdHeader').val( $('#OnlineAdHeading').val() );

                    // copy body
                    var regex = /<br\s*[\/]?>/gi;
                    var content = '<p>' + $('#OnlineAdDescription').val().replace(regex, "\n") + '</p>';
                    var newContent = $(content).text();
                    $('#LineAdText').val(newContent);
                });

                $paramount.upload({
                    url: '@Url.Action("UploadOnlineImage", "Booking")',
                    element: $('#fileupload'),
                    progressBar : $('#onlineImages .progress'),
                    start : function() {
                        // Start
                        designAdModel.errorMsg('');
                        designAdModel.uploadImageInProgress(true);
                    },
                    complete : function(fileId) {
                        // Complete
                        designAdModel.adImages.push(fileId);
                        designAdModel.uploadImageInProgress(false);
                    },
                    error : function(err) {
                        // Error
                        designAdModel.errorMsg(err);
                        designAdModel.uploadImageInProgress(false);
                    }
                });

                var $printImg = $('#imgCropContainer > img');
                var printImgFileName;

                // Upload control for print
                $paramount.upload({
                    url : $paramount.url.uploadCropImage,
                    element: $('#fileuploadPrint'),
                    progressBar: $('#fileUploadPrintProgress'),
                    start: function() {
                    },
                    complete : function(fileName) {
                        printImgFileName = fileName;
                        $('#printCropImg').attr('src', "http://localhost/iflog/Image/RenderCropImage?fileName=" + fileName);
                        $('#printImageCropDialog').modal('show');
                    },
                    error : function(err) {
                        console.log(err);
                    }
                });

                $('#printImageCropDialog').on('shown.bs.modal', function() {
                    $printImg.cropper({
                        aspectRatio: 1,
                        data: {
                            x: 500,
                            y: 500,
                            height: 700,
                            width: 700
                        },
                        modal : true,
                        dashed: false
                    });
                });

                $('#printImageCropDialog').on('hide.bs.modal', function(e) {
                    $printImg.cropper('destroy');
                });

                $('#btnDoneCropping').on('click', function() {
                    var $btn = $(this);
                    $btn.button('loading');
                    var data = $printImg.cropper("getData");
                    data.documentId = printImgFileName;
                    $paramount.svc
                        .cropImage(printImgFileName, data.x, data.y, data.width, data.height)
                        .done(function(documentId) {
                            $btn.button('reset');
                            $('#printImageCropDialog').modal('hide');
                            designAdModel.lineAdImageId(documentId);
                            $paramount.svc.setLineAdImageForBooking(documentId);
                        });
                });

                var DesignAd = function(data, maxImages, lineAdHeader, lineAdText, lineAdImageId) {
                    var self = this;
                    // Images
                    self.adImages = ko.observableArray(data);
                    self.errorMsg = ko.observable("");
                    self.removeImage = function(img) {
                        $.post('@Url.Action("RemoveOnlineImage", "Booking")', { documentId: img }, function(result) {
                            if (result.removed) {
                                self.adImages.remove(img);
                            }
                        });
                        $('#fileupload').removeClass('hidden');
                    };
                    self.maxImages = ko.observable(maxImages);
                    self.maxLimitNotReached = function() {
                        return self.adImages().length < self.maxImages();
                    };
                    self.uploadImageInProgress = ko.observable(false);
                    self.pricelist = ko.observable({ Total: 0, LineItems: { 'Online Ad Cost': 0 } });
                    self.calculate = ko.computed(function() {
                        $.get('@Url.Action("GetRate", "Booking")', null, function(resp) {
                            self.pricelist(resp);
                        });
                    });
                    self.lineAdHeader = ko.observable(lineAdHeader);
                    self.lineAdText = ko.observable(lineAdText);
                    self.wordCount = ko.computed(function() {
                        if (self.lineAdText().length === 0) {
                            return 0;
                        }

                        return self.lineAdText().split(' ').length;
                    });
                    self.lineAdImageId = ko.observable(lineAdImageId);
                    self.removePrintImage = function() {
                        // Clear
                        $paramount.svc
                            .removeLineAdImageForBooking(self.lineAdImageId())
                            .complete(function() {
                                self.lineAdImageId("");
                            });
                    }
                };

                var rawOnlineImages = @Html.Raw(Model.OnlineAdImages.ToJsonString());

                var designAdModel = new DesignAd(rawOnlineImages, @Model.MaxOnlineImages,
                    '@Model.LineAdHeader', '@Html.Raw( Model.LineAdText )', '@Model.LineAdImageId');

                ko.applyBindings(designAdModel);
            });
        })(jQuery, $paramount);
    </script>
}